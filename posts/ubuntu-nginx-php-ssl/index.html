<!DOCTYPE html><html lang="" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="msvalidate.01" content="8C807914E603C21473DF8E153B57EBCB" /><meta name="baidu-site-verification" content="code-XMs8EPRzBg" /><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户" /><meta name="author" content="Piyazon" /><meta property="og:locale" content="" /><meta name="description" content="准备工作 已在实例所属的安全组的入方向添加安全组规格并放行22、80、443端口。" /><meta property="og:description" content="准备工作 已在实例所属的安全组的入方向添加安全组规格并放行22、80、443端口。" /><link rel="canonical" href="https://piyazon.top/posts/ubuntu-nginx-php-ssl/" /><meta property="og:url" content="https://piyazon.top/posts/ubuntu-nginx-php-ssl/" /><meta property="og:site_name" content="Piyazon" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-04-04T12:10:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@Piyazon" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Piyazon"},"description":"准备工作 已在实例所属的安全组的入方向添加安全组规格并放行22、80、443端口。","headline":"Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户","dateModified":"2022-04-28T16:03:19+08:00","url":"https://piyazon.top/posts/ubuntu-nginx-php-ssl/","datePublished":"2022-04-04T12:10:00+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://piyazon.top/posts/ubuntu-nginx-php-ssl/"},"@context":"https://schema.org"}</script><title>Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户 | Piyazon</title><link rel="shortcut icon" type="image/png" href="/assets/img/favicons/favicon.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="mask-icon" href="/assets/img/favicons/safari-pinned-tab.svg" color="#5bbad5"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Piyazon"><meta name="application-name" content="Piyazon"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="stylesheet" href="/assets/jsdelivr/bootstrap.min.css"><link rel="stylesheet" href="/assets/jsdelivr/fontawesome/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/jsdelivr/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/jsdelivr/magnific-popup.min.css"> <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.updateMermaid(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://gitlab.com/Alimjoo/cdn_img/-/raw/main/penguin.svg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Piyazon</a></div><div class="site-subtitle font-italic">Fearless&Far</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a id="mode-toggle-wrapper" tabindex="0" onclick="flipMode()"> <i class="mode-toggle fas fa-adjust"></i> </a> <span class="icon-border"></span> <a href="https://gitee.com/flame2" aria-label="gitee" target="_blank" rel="noopener" > <i class="fab fa-github"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['amichael','mail.ustc.edu.cn'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Type & hit enter..." dir="auto"> <input style="display: none;" class="form-control" id="search-inputtt" type="search" aria-label="search" autocomplete="off" placeholder="Type & hit enter..." dir="auto"> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel">Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户</h1><div class="post-meta text-muted"><div> By <em> <a href="https://piyazon.top">Piyazon</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" date="2022-04-04 12:10:00 +0800" data-toggle="tooltip" data-placement="bottom" title="Mon, Apr 4, 2022, 12:10 PM +0800" >Apr 4, 2022</em> </span> <span> Updated <em class="timeago" date="2022-04-28 16:03:19 +0800 " data-toggle="tooltip" data-placement="bottom" title="Thu, Apr 28, 2022, 4:03 PM +0800" >Apr 28, 2022</em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1017 words"> <em>5 min</em> read</span></div></div></div><div class="post-content"><h1 id="准备工作">准备工作</h1><div class="alert alert-primary">已在实例所属的安全组的入方向添加安全组规格并放行22、80、443端口。</div><ul><li>关闭系统内部防火墙。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>ufw disable
</pre></table></code></div></div><h1 id="安装-nginx">安装 Nginx</h1><li>运行以下命令，更新Ubuntu系统内的软件包。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get update
</pre></table></code></div></div><li>运行以下命令，安装Nginx。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>nginx
</pre></table></code></div></div><li>运行以下命令，查看Nginx版本。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>nginx <span class="nt">-v</span>
</pre></table></code></div></div></ul><h1 id="安装-php">安装 PHP</h1><ul><li>运行以下命令，安装PHP<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>apt-get <span class="nb">install </span>php-fpm
</pre></table></code></div></div><li>运行以下命令，查看PHP版本。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>php <span class="nt">-v</span>
</pre></table></code></div></div><p>返回结果如下所示，查看到PHP版本为7.4.3。同时也表示PHP已成功安装。</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>PHP 7.4.3 <span class="o">(</span>cli<span class="o">)</span> <span class="o">(</span>built: Nov 25 2021 23:16:22<span class="o">)</span> <span class="o">(</span> NTS <span class="o">)</span>
Copyright <span class="o">(</span>c<span class="o">)</span> The PHP Group
Zend Engine v3.4.0, Copyright <span class="o">(</span>c<span class="o">)</span> Zend Technologies
  with Zend OPcache v7.4.3, Copyright <span class="o">(</span>c<span class="o">)</span>, by Zend Technologies
</pre></table></code></div></div><h1 id="配置-nginx">配置 Nginx</h1><li>打开Nginx默认的配置文件<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>vim /etc/nginx/sites-enabled/default
</pre></table></code></div></div><ul><li>在 <code class="language-plaintext highlighter-rouge">server{}</code> 内，找到 <code class="language-plaintext highlighter-rouge">index</code> 开头的配置行，在该行中添加 <code class="language-plaintext highlighter-rouge">index.php</code> 。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>  <span class="c"># Add index.php to the list if you are using PHP</span>
  index index.php index.html index.htm index.nginx-debian.html<span class="p">;</span>
</pre></table></code></div></div><li>在 <code class="language-plaintext highlighter-rouge">server{}</code> 内找到 <code class="language-plaintext highlighter-rouge">location ~ \.php$ {}</code> ，去除以下配置行的注释符号。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>  location ~ <span class="se">\.</span>php<span class="nv">$ </span><span class="o">{</span>
          include snippets/fastcgi-php.conf<span class="p">;</span>
  <span class="c">#</span>
  <span class="c">#       # With php-fpm (or other unix sockets):</span>
          fastcgi_pass unix:/var/run/php/php7.4-fpm.sock<span class="p">;</span>
  <span class="c">#       # With php-cgi (or other tcp sockets):</span>
  <span class="c">#       fastcgi_pass 127.0.0.1:9000;</span>
  <span class="o">}</span>
</pre></table></code></div></div><li>保存并退出文件.</ul><li>运行以下命令，重启Nginx服务。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl restart nginx.service
</pre></table></code></div></div></ul><h1 id="配置-php">配置 PHP</h1><ul><li>运行以下命令，在Nginx网站根目录中，新建phpinfo.php文件。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>vim /var/www/html/phpinfo.php
</pre></table></code></div></div><li>按 <code class="language-plaintext highlighter-rouge">i</code> 进入编辑模式，添加以下配置信息。 phpinfo()函数会展示PHP的所有配置信息。<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre>&lt;?php 
  <span class="nb">echo </span>phpinfo<span class="o">()</span><span class="p">;</span> 
?&gt;
</pre></table></code></div></div><li>保存并退出文件. 运行以下命令，启动PHP.<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>systemctl start php7.4-fpm
</pre></table></code></div></div></ul><h1 id="测试访问php配置信息页面">测试访问PHP配置信息页面</h1><p>一切顺利可以通过公网ip访问网站了.</p><h1 id="配置ssl">配置SSL</h1><ul><li>下载好申请的ssl证书(nginx),放至 <code class="language-plaintext highlighter-rouge">/etc/nginx/ssl</code><li>编辑域名配置文件<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>vim /etc/nginx/sites-enabled/default
</pre></table></code></div></div><li>添加 <code class="language-plaintext highlighter-rouge">443</code> 端口<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>server <span class="o">{</span>
      listen 443 ssl<span class="p">;</span>
      server_name cloud.tencent.com<span class="p">;</span>
      root /var/www/html<span class="p">;</span>
      index index index.php index.html index.htm index.nginx-debian.html<span class="p">;</span>
      <span class="c">#证书文件名称</span>
      ssl_certificate cloud.tencent.com_bundle.crt<span class="p">;</span> 
      <span class="c">#私钥文件名称</span>
      ssl_certificate_key cloud.tencent.com.key<span class="p">;</span> 
      ssl_session_timeout 5m<span class="p">;</span>
      <span class="c">#请按照以下协议配置</span>
      ssl_protocols TLSv1.2 TLSv1.3<span class="p">;</span> 
      <span class="c">#请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span>
      ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE<span class="p">;</span> 
      ssl_prefer_server_ciphers on<span class="p">;</span>
      location / <span class="o">{</span>
              <span class="c"># First attempt to serve request as file, then</span>
              <span class="c"># as directory, then fall back to displaying a 404.</span>
              try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
      <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><li>检验编写是否有误<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nginx <span class="nt">-t</span>
</pre></table></code></div></div><li>重启 <code class="language-plaintext highlighter-rouge">nginx</code><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nginx <span class="nt">-s</span> reload
</pre></table></code></div></div></ul><h1 id="http-自动跳转-https-的安全配置">HTTP 自动跳转 HTTPS 的安全配置</h1><p>编辑域名配置文件</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>vim /etc/nginx/sites-enabled/default
</pre></table></code></div></div><p>再添加一个 <code class="language-plaintext highlighter-rouge">server</code>:</p><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
</pre><td class="rouge-code"><pre>server <span class="o">{</span>
        listen 443 ssl<span class="p">;</span>
        server_name cloud.tencent.com<span class="p">;</span>
        root /var/www/html<span class="p">;</span>
        index index index.php index.html index.htm index.nginx-debian.html<span class="p">;</span>
        <span class="c">#证书文件名称</span>
        ssl_certificate cloud.tencent.com_bundle.crt<span class="p">;</span> 
        <span class="c">#私钥文件名称</span>
        ssl_certificate_key cloud.tencent.com.key<span class="p">;</span> 
        ssl_session_timeout 5m<span class="p">;</span>
        <span class="c">#请按照以下协议配置</span>
        ssl_protocols TLSv1.2 TLSv1.3<span class="p">;</span> 
        <span class="c">#请按照以下套件配置，配置加密套件，写法遵循 openssl 标准。</span>
        ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE<span class="p">;</span> 
        ssl_prefer_server_ciphers on<span class="p">;</span>
        location / <span class="o">{</span>
                <span class="c"># First attempt to serve request as file, then</span>
                <span class="c"># as directory, then fall back to displaying a 404.</span>
                try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ <span class="o">=</span>404<span class="p">;</span>
        <span class="o">}</span>
<span class="o">}</span>
server <span class="o">{</span>
    listen 80<span class="p">;</span>
    <span class="c">#填写绑定证书的域名</span>
    server_name cloud.tencent.com<span class="p">;</span> 
    <span class="c">#把http的域名请求转成https</span>
    <span class="k">return </span>301 https://<span class="nv">$host$request_uri</span><span class="p">;</span> 
<span class="o">}</span>
</pre></table></code></div></div><ul><li>检验编写是否有误<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nginx <span class="nt">-t</span>
</pre></table></code></div></div><li>重启 <code class="language-plaintext highlighter-rouge">nginx</code><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>nginx <span class="nt">-s</span> reload
</pre></table></code></div></div></ul><h1 id="修改php-fpm和nginx运行用户">修改php-fpm和nginx运行用户</h1><p>nginx和php-fpm是www-data用户运行, 想要修改为 www 用户运行</p><h2 id="修改nginx">修改Nginx</h2><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /etc/nginx
<span class="nb">sudo </span>vim nginx.conf
</pre></table></code></div></div><ul><li>头部是这样<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>user www-data<span class="p">;</span>
worker_processes auto<span class="p">;</span>
pid /run/nginx.pid<span class="p">;</span>
include /etc/nginx/modules-enabled/<span class="k">*</span>.conf<span class="p">;</span>
</pre></table></code></div></div><li>修改为<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>user www<span class="p">;</span>
worker_processes auto<span class="p">;</span>
pid /run/nginx.pid<span class="p">;</span>
include /etc/nginx/modules-enabled/<span class="k">*</span>.conf<span class="p">;</span>
</pre></table></code></div></div><li>重启nginx<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>service nginx restart
</pre></table></code></div></div></ul><h2 id="修改php-fpm">修改php-fpm</h2><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /etc/php/7.4/fpm/pool.d/
<span class="nb">sudo </span>vi www.conf
</pre></table></code></div></div><ul><li>找到<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>www-data
</pre></table></code></div></div><li>都改为 <code class="language-plaintext highlighter-rouge">www</code> 应该有4个地方<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>www
</pre></table></code></div></div><li>修改一下文件的权限<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">cd</span> /run/php/
<span class="nb">ls</span> <span class="nt">-al</span>
</pre></table></code></div></div><li>这个目录下面有两个文件<li>php7.4-fpm.pid和php7.4-fpm.sock<li>修改这两个文件的权限<div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nb">sudo chown </span>www:www php7.4-fpm.pid
<span class="nb">sudo chown </span>www:www php7.4-fpm.sock
</pre></table></code></div></div></ul><h2 id="重启php-fpm">重启php-fpm</h2><div class="language-sh highlighter-rouge"><div class="code-header"> <span label-text="Shell"><i class="fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nb">sudo </span>service php7.4-fpm restart
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/blogging/'>Blogging</a>, <a href='/categories/tutorial/'>Tutorial</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/php/" class="post-tag no-text-decoration">php</a> <a href="/tags/ubuntu/" class="post-tag no-text-decoration">ubuntu</a> <a href="/tags/nginx/" class="post-tag no-text-decoration">nginx</a> <a href="/tags/ssl/" class="post-tag no-text-decoration">ssl</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"><h4>Recent Update</h4><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/setup-nextcloud/">Set Up NextCloud and Coturn on Ubuntu 22 Server</a><li><a href="/posts/MathJax-basic-tutorial/">MathJax basic tutorial and quick reference(MathJax教程)</a><li><a href="/posts/how-to-use-online-cal/">如何使用在线积分计算器</a><li><a href="/posts/ubuntu-nginx-php-ssl/">Ubuntu 20.04 Nginx(1.8) PHP(7.4) SSL(https) 修改php-fpm和nginx运行用户</a><li><a href="/posts/mahpiyatlik-1/">مەخپىيەتلىك —— قەدىمقى بابىلوننىڭ بايلىق باشقۇرۇش پاراسەتنامىسى</a></ul></div><div id="access-tags"><h4 class="text-muted">Trending Tags</h4><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%D8%A6%DB%87%D9%8A%D8%BA%DB%87%D8%B1%DA%86%DB%95/">ئۇيغۇرچە</a> <a class="post-tag" href="/tags/%D8%AA%DB%90%D8%B1%DB%95-%D9%82%DB%95%D8%BA%DB%95%D8%B2/">تېرە قەغەز</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/archlinux/">archlinux</a> <a class="post-tag" href="/tags/deepin/">deepin</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssl/">ssl</a> <a class="post-tag" href="/tags/wechat/">wechat</a></div></div></div><script src="/assets/jsdelivr/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><h4 class="pl-3 pt-2 mb-2">Contents</h4><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/setup-nextcloud/"><div class="card-body"> <em class="timeago small" date="2024-11-16 15:10:00 +0800" >Nov 16, 2024</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip dir="auto">Set Up NextCloud and Coturn on Ubuntu 22 Server</h3><div class="text-muted small"><p dir="auto"> In this post, I will setup nextcloud from source on ubuntu 22 server, also set up coturn to enable video call from different IPs. Before start, these are the requirements: a Server(SVN) w...</p></div></div></a></div><div class="card"> <a href="/posts/vps-ssh-locale_error-fix/"><div class="card-body"> <em class="timeago small" date="2024-11-17 11:10:00 +0800" >Nov 17, 2024</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip dir="auto">Fix Locale warning when ssh in to server</h3><div class="text-muted small"><p dir="auto"> When we ssh in to the VPS server or other linux system, some times our local machine language do not match target server language, and we get warning some thing like below, it is very common warnin...</p></div></div></a></div><div class="card"> <a href="/posts/ubuntu-deepin-wechat/"><div class="card-body"> <em class="timeago small" date="2024-12-29 11:10:00 +0800" >Dec 29, 2024</em><h3 class="pt-0 mt-1 mb-3" data-toc-skip dir="auto">Ubuntu install wechat (Ubuntu 安装微信)</h3><div class="text-muted small"><p dir="auto"> deepin-wine deepin-wine环境与应用在Debian/Ubuntu上的移植仓库 使用deepin官方原版软件包 安装QQ/微信只需要两条命令 快速开始 添加仓库 首次使用时，你需要运行如下一条命令将移植仓库添加到系统中。 1 wget -O- https://deepin-wine.i-m.dev/setup.s...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/install-win11-macbook/" class="btn btn-outline-primary" prompt="Older"><p>MacBook 安装 windows11 (使用 Boot Camp Assistant)</p></a> <a href="/posts/how-to-use-online-cal/" class="btn btn-outline-primary" prompt="Newer"><p>如何使用在线积分计算器</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://piyazon.top">Piyazon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">All rights reserved.</span></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><h4 class="text-muted">Trending Tags</h4><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/%D8%A6%DB%87%D9%8A%D8%BA%DB%87%D8%B1%DA%86%DB%95/">ئۇيغۇرچە</a> <a class="post-tag" href="/tags/%D8%AA%DB%90%D8%B1%DB%95-%D9%82%DB%95%D8%BA%DB%95%D8%B2/">تېرە قەغەز</a> <a class="post-tag" href="/tags/macos/">macOS</a> <a class="post-tag" href="/tags/ubuntu/">ubuntu</a> <a class="post-tag" href="/tags/archlinux/">archlinux</a> <a class="post-tag" href="/tags/deepin/">deepin</a> <a class="post-tag" href="/tags/linux/">linux</a> <a class="post-tag" href="/tags/php/">php</a> <a class="post-tag" href="/tags/ssl/">ssl</a> <a class="post-tag" href="/tags/wechat/">wechat</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3" dir="auto"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script> function toHttps(wurl) { return (wurl.slice(0, 4) + "s" + wurl.slice(4)); } if ($(".weixin_video").length) { $.getJSON('https://api.allorigins.win/get?url=' + encodeURIComponent('https://mp.weixin.qq.com/mp/videoplayer?action=get_mp_video_play_url&vid=' + $("#player").attr("wxv")), function (data) { const respon = jQuery.parseJSON(data.contents); $("#player").attr("src", toHttps(respon['url_info'][0]['url'])); }); } </script> <script src="https://piyazon.top/assets/jsdelivr/simple-jekyll-search.min.js"></script> <script> var inputter = document.getElementById('search-inputtt'); document.getElementById('search-input').dispatchEvent(new Event('input', {bubbles:false})); const ENTER_KEY_CODE = 13; document.querySelector('#search-input').addEventListener('keyup', function(e) { if (e.keyCode === ENTER_KEY_CODE) { inputter.value = $(this).val(); inputter.dispatchEvent(new Event('input', {bubbles:true})); } }); SimpleJekyllSearch({ searchInput: document.getElementById('search-inputtt'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}" dir="auto">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p dir="auto">{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="/assets/jsdelivr/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/jsdelivr/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-MLWQK5VDEY"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-MLWQK5VDEY'); }); </script> <script> var h = document.getElementsByTagName("a"); for (let i = 0; i < h.length; i++) { h[i].setAttribute("dir", "auto"); } var pre = document.getElementsByClassName("post-preview"); for (let j = 0; j < pre.length; j++) { pre[j].setAttribute("dir", "auto"); } var table = document.getElementsByClassName("table-wrapper"); for (let i = 0; i < table.length; i++) { table[i].setAttribute("dir", "auto"); } var chlabel = $("track"); if (chlabel.attr("label") === "English&Chinese") { chlabel.attr("label", "English&汉语"); } </script> <script src="/assets/js/plyr/plyr.js"></script> <script> if ($("audio").length) { const player = new Plyr("#audio_player"); } </script> <script> window.onkeyup = vidCtrl; function vidCtrl(e) { const vid = document.querySelector('video'); const key = e.code; switch (key) { case "ArrowLeft": vid.currentTime = vid.currentTime - 15; if (vid.currentTime < 0) { vid.pause(); vid.currentTime = 0; } break; case "ArrowRight": vid.currentTime = vid.currentTime + 15; if (vid.currentTime > vid.duration) { vid.pause(); vid.currentTime = 0; } break; default: break; } } </script>
